<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Roleta de Minérios</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik+Iso&family=Fredoka:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: #111;
      color: white;
      font-family: 'Fredoka', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      padding: 20px 20px 80px;
      position: relative;
    }

    #coinsContainer {
      position: absolute;
      bottom: 20px;
      left: 20px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    #autoMinerBtn {
      margin-bottom: 8px;
      padding: 6px 12px;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      display: none;
    }

    #autoMinerBtn.on {
      background-color: #2ecc71;
      color: white;
    }

    #autoMinerBtn.off {
      background-color: #e74c3c;
      color: white;
    }

    #coinsDisplay {
      font-size: 1.4rem;
      font-weight: bold;
      color: gold;
      text-shadow: 0 0 6px rgba(255,215,0,0.7);
    }

    h1 {
      font-family: 'Rubik Iso', cursive;
      font-size: 6rem;
      margin-bottom: 20px;
      text-align: center;
      line-height: 1;
      text-shadow: 0 4px 8px rgba(0, 0, 0, 0.6);
    }

    #spinButtonContainer {
      margin-bottom: 12px;
    }

    .other-buttons {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 30px;
    }

    .btn {
      padding: 14px 32px;
      font-size: 1.3rem;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }

    #spinButton {
      background-color: white;
      color: #111;
    }

    #backpackButton,
    #chancesButton,
    #sellButton,
    #valuesButton,
    #shopButton {
      background-color: #333;
      color: white;
    }

    .btn:hover:not(:disabled) {
      transform: scale(1.06);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    #displays {
      width: 100%;
      max-width: 600px;
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 25px;
    }

    .display-item {
      width: 100%;
      height: 90px;
      background-color: #222;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      overflow: hidden;
      white-space: nowrap;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }

    #chestButtons {
      display: none;
      gap: 16px;
      margin-top: 20px;
    }

    #ignoreChest {
      background-color: #e74c3c;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    #openChest {
      background-color: #2ecc71;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #1a1a1a;
      width: 90%;
      max-width: 550px;
      max-height: 85vh;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.6);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .modal-content h2 {
      font-size: 1.8rem;
      margin-bottom: 20px;
      text-align: center;
      color: #ffcc00;
    }

    .shop-item {
      background-color: #222;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .shop-info h3 {
      margin-bottom: 6px;
      font-size: 1.3rem;
    }

    .shop-info p {
      color: #aaa;
      font-size: 1.1rem;
    }

    .shop-price {
      font-weight: bold;
      color: gold;
      font-size: 1.3rem;
    }

    .buy-btn {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }

    .buy-btn:hover:not(:disabled) {
      background-color: #2980b9;
    }

    .buy-btn:disabled {
      background-color: #777;
      cursor: not-allowed;
    }

    .section-title {
      font-size: 1.4rem;
      margin: 16px 0 10px;
      color: #ffcc00;
      border-bottom: 1px solid #444;
      padding-bottom: 4px;
    }

    .inventory-container,
    .chances-container,
    .values-container {
      max-height: 350px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .item-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .inventory-item,
    .chance-item,
    .value-item {
      background-color: #222;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .item-name,
    .chance-name,
    .value-name {
      flex: 1;
      text-align: left;
    }

    .item-quantity,
    .chance-value,
    .value-amount {
      color: #aaa;
      font-weight: 600;
      min-width: 60px;
      text-align: right;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 1.2rem;
    }

    select, input {
      width: 100%;
      padding: 12px;
      font-size: 1.2rem;
      border-radius: 8px;
      border: 1px solid #444;
      background-color: #222;
      color: white;
    }

    .sell-buttons {
      display: flex;
      gap: 16px;
      margin-top: 20px;
    }

    .sell-action {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .sell-btn {
      width: 100%;
      padding: 12px;
      font-size: 1.1rem;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: #2ecc71;
      color: white;
      transition: background 0.2s;
    }

    .sell-btn:hover {
      background-color: #27ae60;
    }

    .preview-coins {
      margin-top: 8px;
      font-size: 1rem;
      color: #aaa;
      text-align: center;
    }

    .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #ff4d4d;
      color: white;
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .close-btn:hover {
      background: #ff1a1a;
    }

    #notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #222;
      color: white;
      border: 2px solid white;
      border-radius: 10px;
      padding: 12px 24px;
      font-size: 1.1rem;
      font-weight: bold;
      z-index: 2000;
      display: none;
      align-items: center;
      gap: 8px;
    }

    .icon-error {
      color: #ff4d4d;
    }

    .icon-success {
      color: #2ecc71;
    }
  </style>
</head>
<body>
  <h1>Roleta de Minérios</h1>

  <div id="spinButtonContainer">
    <button id="spinButton" class="btn">Minerar</button>
  </div>

  <div class="other-buttons">
    <button id="sellButton" class="btn">Vender</button>
    <button id="backpackButton" class="btn">Mochila</button>
    <button id="chancesButton" class="btn">Chances</button>
    <button id="valuesButton" class="btn">Valores</button>
    <button id="shopButton" class="btn">Loja</button>
  </div>

  <div id="displays">
    <div class="display-item" id="display1">Clique em Minerar!</div>
  </div>

  <div id="chestButtons">
    <button id="ignoreChest">Ignorar</button>
    <button id="openChest">Abrir por 500 moedas</button>
  </div>

  <div id="coinsContainer">
    <button id="autoMinerBtn" class="off">Minerador: OFF</button>
    <div id="coinsDisplay">Moedas: 0</div>
  </div>

  <div id="notification">
    <span class="icon" id="notifIcon">❌</span>
    <span id="notifText">Mensagem</span>
  </div>

  <!-- Modal da Loja -->
  <div id="shopModal" class="modal">
    <div class="modal-content">
      <button class="close-btn">&times;</button>
      <h2>Loja</h2>
      <div class="shop-item">
        <div class="shop-info">
          <h3>Minerador Automático</h3>
          <p>Minera sozinho (ignora baús)</p>
        </div>
        <div>
          <div class="shop-price">3200</div>
          <button class="buy-btn" id="buyAutoMiner">Comprar</button>
        </div>
      </div>
      <div class="shop-item">
        <div class="shop-info">
          <h3>+1 Mina</h3>
          <p>Minera 2 itens por vez</p>
        </div>
        <div>
          <div class="shop-price">8500</div>
          <button class="buy-btn" id="buyDoubleMine">Comprar</button>
        </div>
      </div>
      <div class="shop-item">
        <div class="shop-info">
          <h3>Velocidade 2.0</h3>
          <p>Animação 2x mais rápida</p>
        </div>
        <div>
          <div class="shop-price">9000</div>
          <button class="buy-btn" id="buySpeed">Comprar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal da Mochila -->
  <div id="backpackModal" class="modal">
    <div class="modal-content">
      <button class="close-btn">&times;</button>
      <h2>Sua Mochila</h2>
      <div class="inventory-container">
        <div id="regularInventory"></div>
        <div id="exclusiveInventory" style="display:none;">
          <div class="section-title">Exclusivos</div>
          <ul id="exclusiveList" class="item-list"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Chances -->
  <div id="chancesModal" class="modal">
    <div class="modal-content">
      <button class="close-btn">&times;</button>
      <h2>Chances dos Itens</h2>
      <div class="chances-container">
        <div id="regularChances"></div>
        <div id="chestChances" style="display:none;">
          <div class="section-title">🎁 Baús</div>
          <ul id="chestList" class="item-list"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Valores -->
  <div id="valuesModal" class="modal">
    <div class="modal-content">
      <button class="close-btn">&times;</button>
      <h2>Valores dos Itens</h2>
      <div class="values-container">
        <ul id="valuesList" class="item-list"></ul>
      </div>
    </div>
  </div>

  <!-- Modal de Venda -->
  <div id="sellModal" class="modal">
    <div class="modal-content">
      <button class="close-btn">&times;</button>
      <h2>Vender Itens</h2>
      <div class="form-group">
        <label for="sellItem">Item:</label>
        <select id="sellItem">
          <option value="">Selecione um item</option>
        </select>
      </div>
      <div class="form-group">
        <label for="sellQuantity">Quantidade:</label>
        <input type="number" id="sellQuantity" min="1" value="1">
      </div>
      <div class="sell-buttons">
        <div class="sell-action">
          <button id="convertBtn" class="sell-btn">Vender</button>
          <div id="previewConvert" class="preview-coins">+0 moedas</div>
        </div>
        <div class="sell-action">
          <button id="convertAllBtn" class="sell-btn">Vender tudo</button>
          <div id="previewConvertAll" class="preview-coins">+0 moedas</div>
        </div>
      </div>
    </div>
  </div>

  <!-- TODO O RESTO DO JOGO (sem salvamento) -->
  <script>
    // === DADOS DO JOGO ===
    const mainItems = [
      { name: '🌳 Terra', weight: 17 },
      { name: '🪓 Madeira', weight: 12 },
      { name: '🌑 Pedra', weight: 9 },
      { name: '⬛ Obsidiana', weight: 8 },
      { name: '🔩 Ferro', weight: 7 },
      { name: '🔶 Cobre', weight: 6.5 },
      { name: '⬜ Quartzo', weight: 5.2 },
      { name: '🟣 Ametista', weight: 4 },
      { name: '🟨 Ouro', weight: 2.5 },
      { name: '💎 Diamante', weight: 1.5 },
      { name: '🟢 Esmeralda', weight: 1.2 },
      { name: '🔴 Rubi', weight: 0.7 },
      { name: '🌞 Pedra do Sol', weight: 0.5 },
      { name: '🔷 Cristal da Lua', weight: 0.02 },
      { name: '☄ Meteorito', weight: 0.007 },
    ];

    const chests = [
      { name: '🎁 Baú', weight: 4, items: [
        { name: '🔴 Rubi', weight: 0.7 },
        { name: '🌞 Pedra do Sol', weight: 0.5 },
        { name: '🔷 Cristal da Lua', weight: 0.2 },
        { name: '☄ Meteorito', weight: 0.1 }
      ]},
      { name: '🎁 Baú Construtivo 🧱', weight: 4.5, items: [
        { name: '🧱 Tijolo', weight: 5 },
        { name: '🔩 Ferro', weight: 2.5 },
        { name: '⚒ Cimento', weight: 1.5 }
      ]},
      { name: '🎁 Baú Espacial🌌', weight: 1, items: [
        { name: '🌕 Pó lunar', weight: 0.7 },
        { name: '💫 Plasma', weight: 0.4 },
        { name: '⚫ Matéria escura', weight: 0.006 }
      ]}
    ];

    const exclusiveItems = new Set([
      '🧱 Tijolo', '⚒ Cimento', '🌕 Pó lunar', '💫 Plasma', '⚫ Matéria escura'
    ]);

    const itemValues = {
      '🌳 Terra': 0.5, '🪓 Madeira': 1, '🌑 Pedra': 2, '⬛ Obsidiana': 5,
      '🔶 Cobre': 6.5, '🔩 Ferro': 7.5, '⬜ Quartzo': 8, '🟣 Ametista': 10,
      '🟨 Ouro': 15, '💎 Diamante': 20, '🟢 Esmeralda': 30, '🔴 Rubi': 50,
      '🌞 Pedra do Sol': 100, '🔷 Cristal da Lua': 500, '☄ Meteorito': 1500,
      '🧱 Tijolo': 3, '⚒ Cimento': 4, '🌕 Pó lunar': 200, '💫 Plasma': 800,
      '⚫ Matéria escura': 5000
    };

    // === Estado do jogo ===
    let inventory = {};
    let unlockedItems = {};
    let coins = 0;
    let chestActive = false;
    let currentChest = null;
    let autoMinerUnlocked = false;
    let autoMinerActive = false;
    let doubleMineUnlocked = false;
    let speedUnlocked = false;
    let autoMinerInterval = null;

    // === FUNÇÕES DE HOOK PARA SALVAMENTO (serão usadas pelo script externo) ===
    window.gameState = {
      get: () => ({
        inventory,
        unlockedItems,
        coins,
        autoMinerUnlocked,
        doubleMineUnlocked,
        speedUnlocked
      }),
      set: (data) => {
        inventory = data.inventory || {};
        unlockedItems = data.unlockedItems || {};
        coins = data.coins || 0;
        autoMinerUnlocked = data.autoMinerUnlocked || false;
        doubleMineUnlocked = data.doubleMineUnlocked || false;
        speedUnlocked = data.speedUnlocked || false;
      },
      updateCoinsDisplay,
      updateDisplaysLayout,
      renderInventory,
      autoMinerBtn: document.getElementById('autoMinerBtn')
    };

    // === Resto do código do jogo (sem salvamento embutido) ===
    const spinButton = document.getElementById('spinButton');
    const shopButton = document.getElementById('shopButton');
    const autoMinerBtn = document.getElementById('autoMinerBtn');
    const display1 = document.getElementById('display1');
    const displaysContainer = document.getElementById('displays');

    function updateCoinsDisplay() {
      document.getElementById('coinsDisplay').textContent = `Moedas: ${coins.toFixed(1)}`;
      // Salvamento será chamado externamente
    }

    function showNotification(message, isSuccess = true) {
      const notif = document.getElementById('notification');
      const icon = document.getElementById('notifIcon');
      const text = document.getElementById('notifText');
      icon.textContent = isSuccess ? '✅' : '❌';
      icon.className = isSuccess ? 'icon-success' : 'icon-error';
      text.textContent = message;
      notif.style.display = 'flex';
      setTimeout(() => notif.style.display = 'none', 5000);
    }

    function getRandomItemFromList(list) {
      const total = list.reduce((sum, item) => sum + item.weight, 0);
      let random = Math.random() * total;
      for (const item of list) {
        if (random < item.weight) return item;
        random -= item.weight;
      }
      return list[list.length - 1];
    }

    function addToInventory(itemName) {
      inventory[itemName] = (inventory[itemName] || 0) + 1;
      unlockedItems[itemName] = true;
      // Salvamento será chamado externamente
    }

    function closeChest() {
      chestActive = false;
      currentChest = null;
      document.getElementById('chestButtons').style.display = 'none';
      spinButton.disabled = false;
    }

    function updateDisplaysLayout() {
      if (doubleMineUnlocked) {
        if (displaysContainer.children.length === 1) {
          const display2 = document.createElement('div');
          display2.className = 'display-item';
          display2.id = 'display2';
          display2.textContent = "Clique em Minerar!";
          displaysContainer.appendChild(display2);
        }
      } else {
        while (displaysContainer.children.length > 1) {
          displaysContainer.removeChild(displaysContainer.lastChild);
        }
      }
    }

    function doMining() {
      if (spinButton.disabled) return;
      const duration = speedUnlocked ? 600 : 1200;
      const intervalTime = speedUnlocked ? 30 : 60;
      spinButton.disabled = true;

      let interval;
      const start = Date.now();
      interval = setInterval(() => {
        if (Date.now() - start >= duration) {
          clearInterval(interval);
          if (doubleMineUnlocked) {
            const item1 = getRandomItemFromList([...mainItems, ...chests]);
            const item2 = getRandomItemFromList([...mainItems, ...chests]);
            display1.textContent = item1.name;
            document.getElementById('display2').textContent = item2.name;

            [item1, item2].forEach(item => {
              if (!item.items) addToInventory(item.name);
            });

            const baus = [item1, item2].filter(item => item.items);
            if (baus.length > 0) {
              chestActive = true;
              currentChest = baus[0];
              document.getElementById('chestButtons').style.display = 'flex';
              return;
            }
          } else {
            const item = getRandomItemFromList([...mainItems, ...chests]);
            display1.textContent = item.name;
            if (item.items) {
              chestActive = true;
              currentChest = item;
              document.getElementById('chestButtons').style.display = 'flex';
              return;
            } else {
              addToInventory(item.name);
            }
          }
          setTimeout(() => { spinButton.disabled = false; }, 500);
        } else {
          const allItems = [...mainItems, ...chests];
          if (doubleMineUnlocked) {
            display1.textContent = allItems[Math.floor(Math.random() * allItems.length)].name;
            document.getElementById('display2').textContent = allItems[Math.floor(Math.random() * allItems.length)].name;
          } else {
            display1.textContent = allItems[Math.floor(Math.random() * allItems.length)].name;
          }
        }
      }, intervalTime);
    }

    function autoMine() {
      if (!autoMinerActive || spinButton.disabled) return;
      if (doubleMineUnlocked) {
        const item1 = getRandomItemFromList(mainItems);
        const item2 = getRandomItemFromList(mainItems);
        addToInventory(item1.name);
        addToInventory(item2.name);
        display1.textContent = item1.name;
        document.getElementById('display2').textContent = item2.name;
      } else {
        const item = getRandomItemFromList(mainItems);
        addToInventory(item.name);
        display1.textContent = item.name;
      }
    }

    function startAutoMiner() {
      if (autoMinerInterval) clearInterval(autoMinerInterval);
      const intervalTime = speedUnlocked ? 650 : 1250;
      autoMinerInterval = setInterval(autoMine, intervalTime);
    }

    function stopAutoMiner() {
      if (autoMinerInterval) {
        clearInterval(autoMinerInterval);
        autoMinerInterval = null;
      }
    }

    function toggleAutoMiner() {
      if (!autoMinerUnlocked) return;
      autoMinerActive = !autoMinerActive;
      autoMinerBtn.className = autoMinerActive ? 'on' : 'off';
      autoMinerBtn.textContent = `Minerador: ${autoMinerActive ? 'ON' : 'OFF'}`;
      if (autoMinerActive) startAutoMiner();
      else stopAutoMiner();
    }

    // === Compras ===
    document.getElementById('buyAutoMiner').onclick = () => {
      if (coins >= 3200 && !autoMinerUnlocked) {
        coins -= 3200;
        autoMinerUnlocked = true;
        autoMinerBtn.style.display = 'block';
        updateCoinsDisplay();
        showNotification("Minerador Automático comprado!");
        // Salvamento externo
      } else if (autoMinerUnlocked) {
        showNotification("Já possui este item!", false);
      } else {
        showNotification("Moedas insuficientes!", false);
      }
    };

    document.getElementById('buyDoubleMine').onclick = () => {
      if (coins >= 8500 && !doubleMineUnlocked) {
        coins -= 8500;
        doubleMineUnlocked = true;
        updateDisplaysLayout();
        updateCoinsDisplay();
        showNotification("+1 Mina ativado!");
        // Salvamento externo
      } else if (doubleMineUnlocked) {
        showNotification("Já possui este item!", false);
      } else {
        showNotification("Moedas insuficientes!", false);
      }
    };

    document.getElementById('buySpeed').onclick = () => {
      if (coins >= 9000 && !speedUnlocked) {
        coins -= 9000;
        speedUnlocked = true;
        updateCoinsDisplay();
        showNotification("Velocidade 2.0 ativada!");
        // Salvamento externo
      } else if (speedUnlocked) {
        showNotification("Já possui este item!", false);
      } else {
        showNotification("Moedas insuficientes!", false);
      }
    };

    // === Baú ===
    document.getElementById('ignoreChest').onclick = () => {
      display1.textContent = "Baú ignorado.";
      if (doubleMineUnlocked) document.getElementById('display2').textContent = "Baú ignorado.";
      closeChest();
    };

    document.getElementById('openChest').onclick = () => {
      if (coins < 500) {
        showNotification("Moedas insuficientes! (500 necessárias)", false);
        return;
      }
      coins -= 500;
      updateCoinsDisplay();
      const rewardItem = getRandomItemFromList(currentChest.items);
      addToInventory(rewardItem.name);
      renderInventory();
      display1.textContent = `Você abriu o baú e ganhou ${rewardItem.name}`;
      if (doubleMineUnlocked) document.getElementById('display2').textContent = "";
      closeChest();
      // Salvamento externo
    };

    spinButton.onclick = () => {
      if (doubleMineUnlocked) {
        display1.textContent = "Clique em Minerar!";
        document.getElementById('display2').textContent = "Clique em Minerar!";
      } else {
        display1.textContent = "Clique em Minerar!";
      }
      doMining();
    };

    autoMinerBtn.onclick = toggleAutoMiner();

    // === Modais ===
    const backpackButton = document.getElementById('backpackButton');
    const chancesButton = document.getElementById('chancesButton');
    const valuesButton = document.getElementById('valuesButton');
    const sellButton = document.getElementById('sellButton');
    const backpackModal = document.getElementById('backpackModal');
    const chancesModal = document.getElementById('chancesModal');
    const valuesModal = document.getElementById('valuesModal');
    const sellModal = document.getElementById('sellModal');
    const shopModal = document.getElementById('shopModal');

    function setupModal(modal) {
      modal.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', () => modal.style.display = 'none');
      });
      window.addEventListener('click', e => {
        if (e.target === modal) modal.style.display = 'none';
      });
    }

    backpackButton.onclick = () => { renderInventory(); backpackModal.style.display = 'flex'; };
    chancesButton.onclick = () => { renderChances(); chancesModal.style.display = 'flex'; };
    valuesButton.onclick = () => { renderValues(); valuesModal.style.display = 'flex'; };
    sellButton.onclick = () => { populateSellDropdown(); updatePreviews(); sellModal.style.display = 'flex'; };
    shopButton.onclick = () => { shopModal.style.display = 'flex'; };

    setupModal(backpackModal);
    setupModal(chancesModal);
    setupModal(valuesModal);
    setupModal(sellModal);
    setupModal(shopModal);

    // === Render ===
    function renderInventory() {
      const regularDiv = document.getElementById('regularInventory');
      const exclusiveDiv = document.getElementById('exclusiveInventory');
      const exclusiveList = document.getElementById('exclusiveList');

      const regularItems = mainItems.filter(item => inventory[item.name] > 0);
      if (regularItems.length > 0) {
        let html = '';
        regularItems.forEach(item => {
          html += `<div class="inventory-item">
            <span class="item-name">${item.name}</span>
            <span class="item-quantity">x${inventory[item.name]}</span>
          </div>`;
        });
        regularDiv.innerHTML = html;
      } else {
        regularDiv.innerHTML = '<div style="text-align:center;color:#777;padding:12px;">Nenhum item comum</div>';
      }

      const exclusiveOwned = Array.from(exclusiveItems).filter(name => inventory[name] > 0);
      if (exclusiveOwned.length > 0) {
        const sorted = exclusiveOwned
          .map(name => ({ name, weight: getExclusiveWeight(name) }))
          .sort((a, b) => b.weight - a.weight)
          .map(x => x.name);

        let html = '';
        sorted.forEach(name => {
          html += `<div class="inventory-item">
            <span class="item-name">${name}</span>
            <span class="item-quantity">x${inventory[name]}</span>
          </div>`;
        });
        exclusiveList.innerHTML = html;
        exclusiveDiv.style.display = 'block';
      } else {
        exclusiveDiv.style.display = 'none';
      }
    }

    function getExclusiveWeight(name) {
      for (const chest of chests) {
        const item = chest.items.find(i => i.name === name);
        if (item) return item.weight;
      }
      return 0;
    }

    function renderChances() {
      const regularDiv = document.getElementById('regularChances');
      const chestDiv = document.getElementById('chestChances');
      const chestList = document.getElementById('chestList');

      let html = '';
      mainItems.forEach(item => {
        const displayName = unlockedItems[item.name] ? item.name : 'Item misterioso';
        html += `<div class="chance-item">
          <span class="chance-name">${displayName}</span>
          <span class="chance-value">${item.weight}</span>
        </div>`;
      });
      regularDiv.innerHTML = html;

      let chestHtml = '';
      chests.forEach(chest => {
        chestHtml += `<div class="chance-item">
          <span class="chance-name">${chest.name}</span>
          <span class="chance-value">${chest.weight}</span>
        </div>`;
        chest.items.forEach(item => {
          const displayName = unlockedItems[item.name] ? item.name : 'Item misterioso';
          chestHtml += `<div class="chance-item" style="padding-left:20px;font-size:1.15rem;">
            <span class="chance-name">- ${displayName}</span>
            <span class="chance-value">${item.weight}%</span>
          </div>`;
        });
      });
      chestList.innerHTML = chestHtml;
      chestDiv.style.display = 'block';
    }

    function renderValues() {
      const list = document.getElementById('valuesList');
      let html = '';

      mainItems.forEach(item => {
        const displayName = unlockedItems[item.name] ? item.name : 'Item misterioso';
        const value = itemValues[item.name] || 0;
        html += `<div class="value-item">
          <span class="value-name">${displayName}</span>
          <span class="value-amount">${value}</span>
        </div>`;
      });

      html += `<div class="section-title">Exclusivos</div>`;

      const allExclusiveItems = [];
      chests.forEach(chest => {
        chest.items.forEach(item => {
          allExclusiveItems.push(item);
        });
      });

      allExclusiveItems.forEach(item => {
        const displayName = unlockedItems[item.name] ? item.name : 'Item misterioso';
        const value = itemValues[item.name] || 0;
        html += `<div class="value-item">
          <span class="value-name">${displayName}</span>
          <span class="value-amount">${value}</span>
        </div>`;
      });

      list.innerHTML = html;
    }

    function populateSellDropdown() {
      const select = document.getElementById('sellItem');
      select.innerHTML = '<option value="">Selecione um item</option>';
      const allOwned = Object.keys(inventory).filter(name => inventory[name] > 0);
      allOwned.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = `${name} (x${inventory[name]})`;
        select.appendChild(opt);
      });
    }

    function updatePreviews() {
      const itemName = document.getElementById('sellItem').value;
      const qty = parseInt(document.getElementById('sellQuantity').value) || 0;
      const preview1 = document.getElementById('previewConvert');
      const preview2 = document.getElementById('previewConvertAll');

      if (itemName && inventory[itemName] > 0) {
        const q = Math.min(qty, inventory[itemName]);
        preview1.textContent = `+${(itemValues[itemName] * q).toFixed(1)} moedas`;
      } else {
        preview1.textContent = '+0 moedas';
      }

      let total = 0;
      for (const name in inventory) {
        if (inventory[name] > 0) total += (itemValues[name] || 0) * inventory[name];
      }
      preview2.textContent = `+${total.toFixed(1)} moedas`;
    }

    function sellItem() {
      const name = document.getElementById('sellItem').value;
      const qty = parseInt(document.getElementById('sellQuantity').value) || 0;
      if (!name || !inventory[name] || qty <= 0) {
        showNotification("Selecione um item e quantidade válida.", false);
        return;
      }
      if (qty > inventory[name]) {
        showNotification("Quantidade insuficiente", false);
        return;
      }
      coins += (itemValues[name] || 0) * qty;
      inventory[name] -= qty;
      if (inventory[name] <= 0) delete inventory[name];
      updateCoinsDisplay();
      populateSellDropdown();
      updatePreviews();
      renderInventory();
      showNotification("Você vendeu os itens");
      // Salvamento externo
    }

    function sellAll() {
      let total = 0;
      for (const name in inventory) {
        if (inventory[name] > 0) total += (itemValues[name] || 0) * inventory[name];
      }
      coins += total;
      inventory = {};
      updateCoinsDisplay();
      populateSellDropdown();
      updatePreviews();
      renderInventory();
      showNotification("Você vendeu todos os itens");
      // Salvamento externo
    }

    document.getElementById('sellItem').onchange = updatePreviews;
    document.getElementById('sellQuantity').oninput = updatePreviews;
    document.getElementById('convertBtn').onclick = sellItem;
    document.getElementById('convertAllBtn').onclick = sellAll;

    // === INICIALIZAÇÃO SEM SALVAMENTO ===
    updateCoinsDisplay();
    updateDisplaysLayout();

    // Eventos de inicialização que o salvamento externo usará
    if (typeof initGame !== 'undefined') {
      initGame();
    }
  </script>
</body>
</html>
